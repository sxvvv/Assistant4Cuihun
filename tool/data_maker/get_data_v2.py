# from zhipu import ZhipuAI
import time 
import json
import random
import datetime
import os
from openai import OpenAI

openai_key = os.getenv("DASHSCOPE_API_KEY")
client = OpenAI(api_key=openai_key, base_url=os.getenv("OPENAI_API_BASE"))

def get_data_openai(messages):
    """
    è°ƒç”¨chat completionsæ¥å£ï¼Œmessagesä¸ºlistå½¢å¼å¯¹è¯ä¸Šä¸‹æ–‡
    """
    response = client.chat.completions.create(
        model="qwen3-235b-a22b",
        messages=messages,
        temperature=1,
    )
    return response.choices[0].message.content

# æ–°å¢é£æ ¼
styles = {
    "å¹½é»˜": {
        "style_temple": "è¯·ç”¨å¹½é»˜é£è¶£çš„è¯­æ°”å·§å¦™å›åº”å‚¬å©šã€‚ç¤ºä¾‹é£æ ¼å‚è€ƒï¼š{}",
        "if_example": True,
        "examples": [
            "åˆ«æ€¥åˆ«æ€¥ï¼Œæˆ‘æ­£åœ¨å’Œæœªæ¥çš„ä½ ç›¸äº²å‘¢ğŸ˜„",
            "å†ç­‰ç­‰ï¼Œæˆ‘æ˜¯æƒ³ç»™è‡ªå·±æ‰¾ä¸ªæ›´å¥½ç©çš„å›¢é˜Ÿleaderã€‚",
            "ç»“å©šï¼Ÿå…ˆæŠŠå¹´è–ªè¾¾åˆ°ç›®æ ‡ï¼Œå†è€ƒè™‘ï¼ğŸ˜‰",
        ],
    },
    "å©‰è½¬": {
        "style_temple": "è¯·ç”¨å©‰è½¬ç¤¼è²Œçš„è¯­æ°”å›åº”å‚¬å©šï¼Œè¡¨è¾¾ç†è§£å’Œå°Šé‡ã€‚",
        "if_example": False,
        "examples": [],
    },
    "ç›´æ¥": {
        "style_temple": "è¯·ç”¨ç›´æˆªäº†å½“ä½†ç¤¼è²Œçš„è¯­æ°”å›åº”å‚¬å©šï¼Œè¡¨è¾¾è‡ªå·±çš„æƒ³æ³•ã€‚",
        "if_example": False,
        "examples": [],
    },
    # æ–°å¢é£æ ¼
    "ç³Šå¼„å­¦": {
        "style_temple": "è¯·ç”¨æ¨¡ç³Šå«ç³Šã€æ‹–å»¶çš„è¯­æ°”å›åº”å‚¬å©šï¼Œæ—¢ä¸æ­£é¢æ‹’ç»ä¹Ÿä¸ç¡®å®šæ‰¿è¯ºã€‚",
        "if_example": True,
        "examples": [
            "è¿™äº‹å˜›ï¼Œå¾—çœ‹ç¼˜åˆ†å§ï¼Œæ€¥ä¸äº†çš„ã€‚",
            "ä½ è¯´çš„å¯¹å•¦ï¼Œæˆ‘ä¹Ÿåœ¨æ…¢æ…¢è€ƒè™‘å‘¢ã€‚",
            "æ”¾å¿ƒå§ï¼Œæœ‰æ—¶é—´å°±ä¼šå»æƒ³æƒ³ã€‚",
        ],
    },
    "å‘ç–¯å¼": {
        "style_temple": "è¯·ç”¨å¤¸å¼ æ— å¥ˆã€â€œå‘ç–¯â€ä½†ä¸å¤±å°Šé‡çš„è¯­æ°”å›åº”å‚¬å©šã€‚",
        "if_example": True,
        "examples": [
            "å“å‘€ï¼Œè¿™å‚¬å©šæ¯”ä¸Šç­è¿˜ç´¯ï¼Œæˆ‘éƒ½å¿«ç–¯äº†ï¼",
            "æˆ‘ç»“ä¸ªå©šæ€ä¹ˆè¿™ä¹ˆéš¾ï¼Œå·®ç‚¹æƒ³æ”¹è¡Œäº†ï¼",
            "å‚¬å©šå‚¬åˆ°æˆ‘å¤´å‘éƒ½è¦æ‰å…‰äº†ï¼",
        ],
    },
    "çªå›Šç»„": {
        "style_temple": "è¯·ç”¨æ— å¥ˆã€å±ˆæœäºç°å®ä½†å¿ƒé‡Œç•¥æœ‰é—æ†¾çš„è¯­æ°”å›åº”å‚¬å©šã€‚",
        "if_example": True,
        "examples": [
            "å”‰ï¼Œè¢«å‚¬å©šå‚¬å¾—æ²¡è„¾æ°”äº†ï¼Œåªèƒ½æ…¢æ…¢æ¥ã€‚",
            "æˆ‘ä¹Ÿæ˜¯å¿ƒé‡Œç€æ€¥ï¼Œåªèƒ½å…ˆå¬çˆ¸å¦ˆçš„ã€‚",
            "å®¶é‡Œå‹åŠ›å¤§ï¼Œåªèƒ½å…ˆåº”ä»˜ç€ã€‚",
        ],
    },
}

name_list = [
    "çˆ¶äº²",
    "æ¯äº²",
    "çˆ·çˆ·",
    "å¥¶å¥¶",
    "å¤–å…¬",
    "å¤–å©†",
    "ä¼¯çˆ¶",
    "ä¼¯æ¯",
    "å”å”",
    "å©¶å©¶",
    "èˆ…èˆ…",
    "èˆ…å¦ˆ",
    "å§¨å¦ˆ",
    "å§¨çˆ¶",
    "å ‚å…„",
    "å ‚å§",
    "å ‚å¼Ÿ",
    "å ‚å¦¹",
    "è¡¨å“¥",
    "è¡¨å§",
    "è¡¨å¼Ÿ",
    "è¡¨å¦¹",
    "é‚»å±…ä¸­çš„é•¿è¾ˆ",
    "å®¶æ—æ—é•¿",
    "å®¶æ—ä¸­è¾ˆåˆ†è¾ƒé«˜çš„äº²æˆš",
    "çˆ¶æ¯çš„æœ‹å‹",
    "èŒåœºä¸­æ¯”è‡ªå·±å¹´é•¿çš„é¢†å¯¼",
    "è¿œæˆ¿äº²æˆš",
]

scenes = [
    "å®¶åº­èšä¼šå‚¬å©š",
    "æ˜¥èŠ‚å›¢åœ†é¥­è¢«å‚¬å©š",
    "ä¸­ç§‹èŠ‚å®¶äººè§†é¢‘é€šè¯å‚¬å©š",
    "çº¿ä¸Šå®¶åº­å¾®ä¿¡ç¾¤å‚¬å©š",
    "äº²æˆšèšä¼šå½“ä¼—å‚¬å©š",
    "èŒåœºä¸Šçº§å‚¬å©š",
    "è¢«å®‰æ’ç›¸äº²ä»‹ç»å¯¹è±¡",
    "ä¹¡ä¸‹é•¿è¾ˆä¼ ç»Ÿå‚¬å©šå‹åŠ›",
    "ç¥–è¾ˆå¯¹å©šå§»è§‚å¿µä¼ ç»Ÿå‚¬å©š",
    "é•¿è¾ˆå…³å¿ƒå¼è½»ææ·¡å†™å‚¬å©š",
    "èŠ‚å‡æ—¥äº²å‹é—®æœ‰æ²¡æœ‰å¯¹è±¡",
    "è¢«çˆ¶æ¯å¤šæ¬¡ç”µè¯/çŸ­ä¿¡å‚¬å©š",
    "è¢«äº²æˆšå†·å˜²çƒ­è®½å‚¬å©š",
    "é¢å¯¹å¼ºåŠ¿å‚¬å©šçš„æ— å¥ˆäº¤æµ",
    "å©šæ‹è¯é¢˜é¿ä¸å¼€çš„å®¶åº­èšé¤",
    "å¹´å¤œé¥­å…¨å®¶å‚¬å©šæ°›å›´",
    "çˆ¶æ¯äº²å¯†æœ‹å‹å¥—è¿‘ä¹å‚¬å©š",
    "èŒåœºé•¿è¾ˆé¥­å±€å«è“„å‚¬å©š",
    "è¢«äº²æˆšåœ¨æœ‹å‹åœˆæš—ç¤ºå‚¬å©š",
    "çº¿ä¸Šå®¶åº­ç¾¤èŠæ¿€çƒˆå‚¬å©šäº‰è®º",
    "çˆ¶æ¯ç„¦è™‘æƒ…ç»ªå‚¬å©šï¼Œä»¤äººç”Ÿå‹åŠ›å¤§",
    "å§‘å¦ˆé˜¿å§¨é€æ¥ç›¸äº²ä»‹ç»ç¤¼ç‰©åœºåˆ",
    "é¢å¯¹â€œå†ä¸ç»“å©šå°±æ™šäº†â€çš„ç„¦è™‘è¨€è¾",
    "å©šå§»è¯é¢˜è¢«é•¿è¾ˆåå¤æåŠå¯¼è‡´å°´å°¬",
    "å¹´èŠ‚æ‹œå¹´é€”ä¸­è¢«å¤šæ¬¡è¯¢é—®å©šæ‹æƒ…å†µ",
]

random_finalprompt_sentence = [
    "",  # é»˜è®¤æ— é™„åŠ 
    "è¯·å›ç­”ä¸­ä½“ç°å¯¹é•¿è¾ˆçš„å°Šé‡å’Œå…³æ€€ã€‚",
    "è¯·åŠ å…¥ä¸€ç‚¹å¹½é»˜æ„Ÿæ¥ç¼“è§£æ°›å›´ã€‚",
    "è¯·é¿å…è¿‡äºç›´æ¥ï¼Œå°½é‡è½»æ¾åŒ–è§£ã€‚",
    "è¯·ä¿æŒè¯­è¨€ç®€æ´æ˜äº†ã€‚",
]

final_prompt_template = """
ä½ æ˜¯ä¸€ä¸ªå¹´è½»äººï¼Œé¢å¯¹é•¿è¾ˆ<{name}>åœ¨{scene}åœºæ™¯ä¸‹å‚¬å©šã€‚
è¯·ç”¨{style}é£æ ¼ï¼Œç”Ÿæˆä¸¤è½®ç®€çŸ­å¯¹è¯æ¥å›åº”é•¿è¾ˆçš„å‚¬å©šï¼Œ
ç¬¬ä¸€è½®æ˜¯é•¿è¾ˆå‚¬å©šçš„è¯ï¼ˆè¯·ä½ æ¨¡æ‹Ÿä¸€å¥é•¿è¾ˆçš„å…¸å‹å‚¬å©šè¯è¯­ï¼‰ï¼Œ
ç¬¬äºŒè½®æ˜¯ä½ çš„å›åº”ï¼Œè¦å·§å¦™ä¸”ç¤¼è²Œï¼Œç¬¦åˆé£æ ¼ç‰¹ç‚¹ã€‚
{extra}
è¯·åªè¿”å›è¿™ä¸¤å¥è¯ï¼Œä¸­é—´ä¸è¦æœ‰å¤šä½™å…¶ä»–è¯´æ˜ã€‚
"""

def main():
    roop_count = 2  # å¾ªç¯æ¬¡æ•°
    now_count = 0

    conversations = []

    for _ in range(roop_count):
        for name in name_list:
            for scene in scenes:
                try:
                    style_name = random.choice(list(styles.keys()))
                    style_config = styles[style_name]

                    if style_config["if_example"]:
                        example = random.choice(style_config["examples"])
                        style_prompt = style_config["style_temple"].format(example)
                    else:
                        style_prompt = style_config["style_temple"]

                    extra_prompt = random.choice(random_finalprompt_sentence)

                    prompt = final_prompt_template.format(
                        name=name,
                        scene=scene,
                        style=style_prompt,
                        extra=extra_prompt,
                    )
                    messages = [
                        {
                            "role": "system",
                            "content": "ä½ ç°åœ¨æ˜¯ä¸€ä¸ªæ“…é•¿åº”å¯¹é•¿è¾ˆå‚¬å©šçš„å¹´è½»äººï¼Œå–„äºç”¨ä¸åŒé£æ ¼å·§å¦™ä¸”ç¤¼è²Œåœ°å›åº”é•¿è¾ˆã€‚"
                        },
                        {
                            "role": "user",
                            "content": prompt,
                        }
                    ]

                    response = get_data_openai(messages)
                    now_count += 1

                    conversation = {
                        "conversation": [
                            {
                                "system": "ä½ ç°åœ¨æ˜¯ä¸€ä¸ªæ“…é•¿åº”å¯¹é•¿è¾ˆå‚¬å©šçš„å¹´è½»äººï¼Œå–„äºç”¨ä¸åŒé£æ ¼å·§å¦™ä¸”ç¤¼è²Œåœ°å›åº”é•¿è¾ˆã€‚",
                                "src_input": prompt,
                                "style_name": style_name,
                                "input": f"å‚¬å©šå›åº”ç»™{name}ï¼Œåœºæ™¯ {scene}ï¼Œé£æ ¼ {style_name}",
                                "output": response,
                            }
                        ]
                    }

                    conversations.append(conversation)
                    print(f"å¯¹è±¡: {name}, åœºæ™¯: {scene}, é£æ ¼: {style_name}, å›åº”:\n{response}")
                    print(f"å½“å‰å·²ç”Ÿæˆæ•°ç›®: {now_count}")

                except Exception as e:
                    print(f"ç”Ÿæˆå¤±è´¥ï¼Œé”™è¯¯: {e}")
                    continue

    now_time = datetime.datetime.now().strftime("%Y-%m-%d-%H-%M-%S")
    file_path = f"marriage_responses_enhanced_{now_time}.json"
    with open(file_path, "w", encoding="utf-8") as f:
        json.dump(conversations, f, ensure_ascii=False, indent=4)
    print(f"ç”Ÿæˆå®Œæ¯•ï¼Œä¿å­˜æ–‡ä»¶ï¼š{file_path}")


if __name__ == "__main__":
    main()
